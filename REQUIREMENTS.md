# ピッチスカウト - 要件定義書

> AI声域分析＆楽曲推薦アプリケーションの機能・非機能要件

**バージョン**: 1.0  
**最終更新**: 2026年2月19日  
**プロジェクト**: 2026_team11

---

## 📋 目次

- [1. プロダクト概要](#1-プロダクト概要)
- [2. 機能要件](#2-機能要件)
- [3. 非機能要件](#3-非機能要件)
- [4. データ要件](#4-データ要件)
- [5. インターフェース要件](#5-インターフェース要件)
- [6. 制約事項](#6-制約事項)
- [7. 将来の拡張](#7-将来の拡張)

---

## 1. プロダクト概要

### 1.1 プロダクトビジョン

「カラオケで自分に合う曲を見つけられない」という課題を、AI技術を活用した声域分析と楽曲データベースのマッチングによって解決する。ユーザーは数秒の録音だけで、自分の声域を客観的に把握し、歌いやすい曲を発見できる。

### 1.2 ターゲットユーザー

**主要ターゲット**:
- カラオケ初心者〜中級者
- 自分の声域を正確に知りたい人
- 曲選びで失敗したくない人
- 新しい曲を開拓したい人

**ペルソナ例**:
- **山田さん（28歳・会社員）**: 月1回のカラオケで毎回同じ曲を歌ってしまう。新しい曲に挑戦したいが、自分に合う曲がわからない
- **佐藤さん（22歳・大学生）**: サークルのカラオケで「歌ってみたらサビが高すぎた」という失敗を何度も経験している
- **田中さん（35歳・主婦）**: ボイトレに通っているが、自分の声域の変化を客観的に記録したい

### 1.3 提供価値

1. **声域の客観的把握**: 地声・裏声の音域を自動判定、科学的根拠に基づいた分析
2. **失敗しない曲選び**: 3,900曲のデータベースから自分の声域に合う曲を検索
3. **成長の可視化**: 分析履歴で声域の変化を追跡
4. **手軽さ**: スマホのマイクで数秒録音するだけ

### 1.4 成功指標（KPI）

- **ユーザー登録数**: 月間100名（初年度目標）
- **分析実行回数**: ユーザーあたり月3回以上
- **リピート率**: 30日リテンション 40%以上
- **分析成功率**: 90%以上（エラーなく分析完了）
- **ユーザー満足度**: NPS スコア 40以上

---

## 2. 機能要件

### 2.1 声域分析機能

#### 2.1.1 マイク録音分析（FR-001）

**概要**: ブラウザのマイクを使用してアカペラ音声を録音し、声域を分析する

**機能詳細**:
- マイクアクセスの許可取得
- リアルタイム波形表示（録音中）
- 録音時間: 5秒〜60秒（推奨10秒以上）
- 音声フォーマット: WebM（ブラウザ）→ WAV（サーバー変換）
- ノイズ除去処理の適用

**入力**:
- ユーザーのマイク音声（アカペラ）

**出力**:
- 地声最低音（例: mid1C）
- 地声最高音（例: hiA）
- 裏声最高音（例: hiD）
- 地声率・裏声率（%）
- 音域の広さ（半音数）

**処理フロー**:
```
録音開始 → ノイズ除去 → CREPE(ピッチ検出) → スペクトル分析
→ 地声/裏声判定 → オクターブ誤り補正 → 結果表示
```

**非機能要件**:
- 処理時間: 10-30秒以内
- 精度: 地声/裏声の判定精度 85%以上

#### 2.1.2 カラオケ音源分析（FR-002）

**概要**: カラオケで録音した音源（BGM付き）をアップロードし、ボーカル分離後に声域を分析する

**機能詳細**:
- ファイルアップロード（最大50MB）
- Demucs（Meta AI）によるボーカル分離
- 3つのモード選択:
  - **超高速モード**: htdemucs_6s（30秒-1分、精度やや低）
  - **高速モード**: htdemucs（1-2分、バランス型）
  - **高品質モード**: htdemucs_ft（3-5分、最高精度）
- 分離後のボーカルに対して声域分析

**対応フォーマット**:
- 音声: WAV, MP3, M4A, FLAC, WebM
- 動画: MP4, MOV（音声トラック抽出）

**処理フロー**:
```
ファイルアップロード → 音声変換(HQ) → Demucs(ボーカル分離)
→ ノイズ除去 → 声域分析 → 結果表示
```

**非機能要件**:
- 処理時間: 
  - CPU: 1-3分（高速）、3-5分（高品質）
  - GPU: 30秒-1分（高速）、1-2分（高品質）
- ファイルサイズ上限: 50MB
- 対応時間: 最大10分の音源

#### 2.1.3 ファイルアップロード分析（FR-003）

**概要**: アカペラ音声ファイルを直接アップロードして分析

**機能詳細**:
- マイク録音と同じ分析処理
- ボーカル分離なし（アカペラ前提）

**対応フォーマット**: WAV, MP3, M4A, FLAC, WebM

### 2.2 楽曲検索機能

#### 2.2.1 声域マッチング検索（FR-101）

**概要**: ユーザーの声域に合う楽曲を検索する

**検索条件**:
- 地声最高音が自分の地声範囲内
- 裏声最高音が自分の裏声範囲内
- 最低音が自分の声域下限以上

**フィルター**:
- アーティスト名
- 曲名（部分一致）
- 音域範囲（最低音〜最高音）
- 並び替え（マッチ度、人気順、音域順）

**表示項目**:
- 曲名
- アーティスト名
- 最低音・最高音・裏声最高音
- マッチ度スコア
- 推奨キー（キー変更の提案）

**ページネーション**:
- 1ページあたり20-50件
- 無限スクロール対応

#### 2.2.2 アーティスト別楽曲一覧（FR-102）

**概要**: アーティストごとの楽曲を一覧表示

**機能詳細**:
- 260組のアーティスト
- アーティストごとの楽曲リスト
- 音域情報の表示
- お気に入り登録（ログイン時）

#### 2.2.3 フリーワード検索（FR-103）

**概要**: 曲名・アーティスト名で自由検索

**検索方式**:
- 部分一致検索
- ひらがな・カタカナ・漢字対応
- スペース区切りでAND検索

### 2.3 ユーザー認証・管理機能

#### 2.3.1 ユーザー登録（FR-201）

**方式**: メールアドレス＋パスワード

**入力項目**:
- メールアドレス（必須、一意）
- パスワード（必須、8文字以上）
- 表示名（オプション）

**処理**:
- Supabase Authによる認証
- メール確認（オプション）
- user_profilesテーブルに自動登録

#### 2.3.2 ログイン・ログアウト（FR-202）

**ログイン方式**:
- メール＋パスワード
- セッション管理（JWT）
- リフレッシュトークン対応

**ログアウト**:
- セッション破棄
- ローカルストレージクリア

#### 2.3.3 プロファイル管理（FR-203）

**表示・編集項目**:
- 表示名
- アバター画像（将来実装）
- 現在の声域（最新分析結果から自動更新）
- DAMアカウント連携（将来実装）

#### 2.3.4 パスワード管理（FR-204）

**機能**:
- パスワード変更（マイページ）
- パスワードリセット（メール送信）

### 2.4 分析履歴機能

#### 2.4.1 履歴保存（FR-301）

**保存情報**:
- 分析日時
- 声域データ（最低音、地声最高音、裏声最高音）
- ソースタイプ（マイク/カラオケ/ファイル）
- ファイル名（オプション）

**保存条件**:
- ログイン済みユーザーのみ
- 自動保存（分析完了時）

#### 2.4.2 履歴閲覧（FR-302）

**表示**:
- 時系列一覧（新しい順）
- 声域の推移グラフ（将来実装）
- 各分析の詳細表示

**フィルター**:
- 期間指定（過去7日、30日、全期間）
- ソースタイプ別

### 2.5 お気に入り機能

#### 2.5.1 お気に入り登録・解除（FR-401）

**機能**:
- 楽曲をお気に入りに追加
- お気に入りから削除
- お気に入り状態の表示（ハートアイコン）

**条件**:
- ログイン済みユーザーのみ

#### 2.5.2 お気に入り一覧（FR-402）

**表示**:
- お気に入り登録した楽曲リスト
- 登録日時順、アーティスト順で並び替え
- 楽曲詳細へのリンク

### 2.6 推薦機能（高度）

#### 2.6.1 おすすめ曲提案（FR-501）

**アルゴリズム**:
- 声域マッチング
- 音域の広さとの適合度
- 人気度（将来実装）
- 前回歌った曲との類似度（将来実装）

#### 2.6.2 キー変更提案（FR-502）

**機能**:
- 曲の音域とユーザー声域を比較
- 最適なキー変更値を算出（±6半音）
- 「+2キーで歌いやすい」等のガイド表示

#### 2.6.3 類似アーティスト検索（FR-503）

**機能**:
- 音域の似たアーティストを提案
- 好きなアーティストから関連アーティスト発見

#### 2.6.4 声質タイプ判定（FR-504）

**判定基準**:
- 音域の広さ（オクターブ数）
- 地声/裏声比率
- 声域の高さ

**出力タイプ例**:
- 「低音型」「高音型」「バランス型」
- 「地声寄り」「裏声得意」

---

## 3. 非機能要件

### 3.1 性能要件（NFR-100）

#### 3.1.1 レスポンスタイム

| 機能 | 目標時間 | 最大許容時間 |
|------|----------|-------------|
| ページ読み込み | 2秒以内 | 5秒 |
| マイク録音分析 | 10-30秒 | 60秒 |
| カラオケ音源分析（高速） | 30秒-1分 | 3分 |
| カラオケ音源分析（高品質） | 1-3分 | 5分 |
| 楽曲検索 | 1秒以内 | 3秒 |
| ログイン | 2秒以内 | 5秒 |

#### 3.1.2 スループット

- 同時接続ユーザー: 50-100名
- 同時分析処理: 5-10リクエスト（サーバースペック依存）

#### 3.1.3 リソース使用量

- メモリ: 1分析あたり最大2GB
- ディスク: 一時ファイル 1アップロードあたり最大100MB
- CPU: Demucs処理時に全コア使用（正常動作）

### 3.2 可用性要件（NFR-200）

- **稼働率**: 99.0%（月間ダウンタイム7.2時間以内）
- **メンテナンス時間**: 深夜2-4時（事前告知）
- **障害復旧時間**: 4時間以内

### 3.3 拡張性要件（NFR-300）

- **ユーザー数**: 初年度1,000名、将来10,000名まで対応
- **楽曲データ**: 現在3,900曲、将来50,000曲まで拡張可能
- **データベース容量**: SQLite 500MB → PostgreSQL移行可能
- **水平スケーリング**: ロードバランサー + 複数インスタンス対応

### 3.4 セキュリティ要件（NFR-400）

#### 3.4.1 認証・認可
- パスワードハッシュ化（bcrypt、Supabase管理）
- JWT（JSON Web Token）による認証
- セッション有効期限: 7日間
- リフレッシュトークン: 30日間

#### 3.4.2 通信暗号化
- HTTPS必須（TLS 1.2以上）
- APIリクエストの暗号化

#### 3.4.3 データ保護
- 個人情報の適切な管理
- Row Level Security（RLS）有効化（Supabase）
- パスワードリセットトークンの有効期限: 1時間

#### 3.4.4 入力検証
- ファイルアップロード: 
  - サイズ上限: 50MB
  - MIME typeチェック（audio/*, video/*）
  - ファイル拡張子ホワイトリスト
- SQLインジェクション対策（ORMプレースホルダー使用）
- XSS対策（React自動エスケープ）

#### 3.4.5 アクセス制御
- CORS設定（許可ドメインのみ）
- レート制限: 1IPあたり100リクエスト/分（将来実装）

### 3.5 運用性要件（NFR-500）

#### 3.5.1 ログ
- アクセスログ: Nginx
- アプリケーションログ: 標準出力（Supervisor経由）
- エラーログ: スタックトレース付き
- ログローテーション: 毎日、30日間保持

#### 3.5.2 監視
- ヘルスチェックエンドポイント: `/health`
- メトリクス: CPU、メモリ、ディスク使用率
- アラート: ダウン検知、エラー率5%超過

#### 3.5.3 バックアップ
- SQLite: 毎日自動バックアップ、30日間保持
- Supabase: 自動バックアップ（Proプラン）、手動バックアップ可
- 復旧テスト: 月1回実施

### 3.6 互換性要件（NFR-600）

#### 3.6.1 ブラウザ対応
- **Chrome**: 90以降（推奨）
- **Safari**: 14以降
- **Firefox**: 88以降
- **Edge**: 90以降
- **モバイル**: Chrome (Android), Safari (iOS)

#### 3.6.2 OS対応
- **デスクトップ**: Windows 10/11, macOS 11+, Ubuntu 20.04+
- **モバイル**: iOS 14+, Android 10+

#### 3.6.3 画面サイズ
- **デスクトップ**: 1280x720以上推奨
- **タブレット**: 768x1024
- **スマートフォン**: 375x667以上

### 3.7 ユーザビリティ要件（NFR-700）

- **初回利用の習得時間**: 5分以内
- **タスク完了率**: 声域分析 90%以上
- **エラーメッセージ**: 日本語、具体的な対処法を提示
- **アクセシビリティ**: WCAG 2.1 AA準拠（将来目標）

### 3.8 保守性要件（NFR-800）

- **コードカバレッジ**: 50%以上（テスト実装後）
- **ドキュメント**: README、セットアップガイド、API仕様書
- **バージョン管理**: Git、セマンティックバージョニング
- **デプロイ手順書**: DEPLOYMENT.md

---

## 4. データ要件

### 4.1 データモデル

#### 4.1.1 Supabase（PostgreSQL）

**user_profiles（ユーザープロファイル）**
```sql
id                      UUID PRIMARY KEY      -- Supabase Auth連携
email                   TEXT UNIQUE NOT NULL
display_name            TEXT
avatar_url              TEXT
dam_account_id          TEXT                  -- 将来
current_vocal_range_min TEXT                  -- 例: "mid1C"
current_vocal_range_max TEXT                  -- 例: "hiA"
current_falsetto_max    TEXT                  -- 例: "hiE"
created_at              TIMESTAMP
updated_at              TIMESTAMP
```

**analysis_history（分析履歴）**
```sql
id                UUID PRIMARY KEY
user_id           UUID FOREIGN KEY → user_profiles
vocal_range_min   TEXT
vocal_range_max   TEXT
falsetto_max      TEXT
source_type       TEXT ('microphone', 'karaoke', 'file')
file_name         TEXT
created_at        TIMESTAMP
```

**favorite_songs（お気に入り）**
```sql
id          UUID PRIMARY KEY
user_id     UUID FOREIGN KEY → user_profiles
song_id     INTEGER FOREIGN KEY → songs (SQLite)
created_at  TIMESTAMP
```

#### 4.1.2 SQLite（ローカル）

**artists（アーティスト）**
```sql
id          INTEGER PRIMARY KEY
name        TEXT UNIQUE NOT NULL
slug        TEXT UNIQUE NOT NULL
song_count  INTEGER DEFAULT 0
```

**songs（楽曲）**
```sql
id              INTEGER PRIMARY KEY
title           TEXT NOT NULL
artist_id       INTEGER FOREIGN KEY → artists
lowest_note     TEXT         -- 例: "mid1C"
highest_note    TEXT         -- 例: "hiC"
falsetto_max    TEXT         -- 例: "hiE"
source_url      TEXT         -- スクレイピング元URL
```

### 4.2 データ量見積もり

| データ | 現在 | 1年後（予測） |
|--------|------|--------------|
| ユーザー数 | 0 | 1,000名 |
| 楽曲データ | 3,900曲 | 5,000曲 |
| 分析履歴 | 0 | 30,000件（1人30回） |
| お気に入り | 0 | 50,000件（1人50曲） |
| ストレージ（一時ファイル） | 0 | 10GB（定期削除） |

### 4.3 データ保持期間

- **SQLite（songs.db）**: 永続
- **ユーザープロファイル**: アカウント削除まで永続
- **分析履歴**: 永続（削除機能は将来実装）
- **お気に入り**: 永続
- **一時ファイル（uploads, separated）**: 24時間後自動削除

---

## 5. インターフェース要件

### 5.1 API仕様

**ベースURL**: `https://api.your-domain.com`

#### 5.1.1 認証API

| エンドポイント | メソッド | 説明 | 認証 |
|---------------|---------|------|-----|
| `/auth/signup` | POST | ユーザー登録 | 不要 |
| `/auth/signin` | POST | ログイン | 不要 |
| `/auth/signout` | POST | ログアウト | 必要 |
| `/auth/refresh` | POST | トークン更新 | 不要 |
| `/auth/reset-password` | POST | パスワードリセット | 不要 |
| `/auth/update-password` | POST | パスワード変更 | 必要 |

#### 5.1.2 分析API

| エンドポイント | メソッド | 説明 | 認証 |
|---------------|---------|------|-----|
| `/analyze` | POST | マイク録音分析 | オプション |
| `/analyze-karaoke` | POST | カラオケ音源分析 | オプション |

#### 5.1.3 楽曲API

| エンドポイント | メソッド | 説明 | 認証 |
|---------------|---------|------|-----|
| `/songs` | GET | 楽曲検索・一覧 | 不要 |
| `/songs/{id}` | GET | 楽曲詳細 | 不要 |

#### 5.1.4 ユーザーAPI

| エンドポイント | メソッド | 説明 | 認証 |
|---------------|---------|------|-----|
| `/profile/me` | GET | プロファイル取得 | 必要 |
| `/profile/me` | PUT | プロファイル更新 | 必要 |
| `/analysis/history` | GET | 分析履歴 | 必要 |
| `/favorites` | GET | お気に入り一覧 | 必要 |
| `/favorites` | POST | お気に入り追加 | 必要 |
| `/favorites/{song_id}` | DELETE | お気に入り削除 | 必要 |

### 5.2 外部API依存

- **Supabase REST API**: 認証、データベース操作
- **Supabase Realtime**（将来）: リアルタイム通知

### 5.3 UI/UXガイドライン

- **デザインシステム**: Tailwind CSS
- **カラースキーム**: 
  - プライマリ: ブルー系
  - アクセント: オレンジ・レッド
- **レスポンシブデザイン**: モバイルファースト
- **アイコン**: Heroicons
- **フォント**: システムフォント（-apple-system, Segoe UI, ...）

---

## 6. 制約事項

### 6.1 技術的制約

1. **ブラウザAPIの制約**:
   - マイクアクセスはHTTPSまたはlocalhostのみ
   - ブラウザによって録音フォーマットが異なる（WebM/WAV）

2. **音声処理の精度**:
   - ノイズが多い環境では分析精度が低下
   - 地声/裏声の境界判定が曖昧なケースあり（ミックスボイス等）
   - 極端な高音・低音は検出精度が下がる

3. **処理時間**:
   - Demucsは高精度だが処理時間がかかる（CPU: 3-5分）
   - リアルタイム分析は不可

4. **ストレージ制限**:
   - 一時ファイルの定期削除が必要
   - ディスク容量不足でアップロード失敗の可能性

### 6.2 法的・ライセンス制約

1. **楽曲データ**:
   - voice-key.newsから公開情報をスクレイピング
   - 楽曲の音源・歌詞は含まない（音域情報のみ）
   - 著作権侵害に該当しない範囲での利用

2. **ユーザーデータ**:
   - 個人情報保護法準拠
   - プライバシーポリシー・利用規約の整備（将来）
   - GDPRコンプライアンス（海外展開時）

3. **オープンソースライセンス**:
   - PyTorch: BSD License
   - Demucs: MIT License
   - FastAPI: MIT License
   - React: MIT License

### 6.3 運用制約

1. **人的リソース**:
   - 開発チーム: 1-3名（小規模）
   - 運用担当: 兼任
   - サポート: メール対応のみ

2. **予算制約**:
   - インフラコスト: 月間$50-$300
   - 外部サービス（Supabase）: $0-$25/月

3. **時間制約**:
   - 開発期間: 3ヶ月（MVP完成）
   - メンテナンス: 週2時間程度

---

## 7. 将来の拡張

### 7.1 短期（3-6ヶ月）

- [ ] **DAM連携**: DAMカラオケアプリとの連携、歌唱履歴取得
- [ ] **SNSシェア**: 分析結果をTwitter/LINEでシェア
- [ ] **声域推移グラフ**: 分析履歴を折れ線グラフで可視化
- [ ] **プレイリスト作成**: お気に入り曲からプレイリスト生成
- [ ] **通知機能**: 新曲追加、声域更新の通知

### 7.2 中期（6-12ヶ月）

- [ ] **Google OAuth**: Googleアカウントでログイン
- [ ] **Apple Music連携**: Apple Musicの楽曲情報取得
- [ ] **音域比較**: 他ユーザーとの声域比較（匿名）
- [ ] **ボイトレアドバイス**: AIによる発声改善提案
- [ ] **楽曲レビュー**: ユーザーによる楽曲の難易度レビュー

### 7.3 長期（1年以上）

- [ ] **モバイルアプリ**: iOS/Android ネイティブアプリ
- [ ] **リアルタイム分析**: 歌いながら音程表示
- [ ] **コミュニティ機能**: ユーザー同士の交流
- [ ] **サブスクリプション**: プレミアム機能の提供
- [ ] **AI歌声合成**: 自分の声で楽曲プレビュー（技術検証必要）
- [ ] **多言語対応**: 英語、中国語、韓国語

### 7.4 技術的負債の解消

- [ ] テストコードの追加（Jest, pytest）
- [ ] CI/CDパイプライン構築（GitHub Actions）
- [ ] パフォーマンス最適化（Redis キャッシュ）
- [ ] SQLite → PostgreSQL完全移行
- [ ] マイクロサービス化（分析エンジンの分離）

---

## 8. 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|--------|
| 1.0 | 2026-02-19 | 初版作成 | - |

---

## 9. 承認

| 役割 | 氏名 | 署名 | 日付 |
|------|------|------|------|
| プロダクトオーナー | - | - | - |
| 開発リーダー | - | - | - |
| QA担当 | - | - | - |

---

**お問い合わせ**: GitHub Issues
